% This script is intended to address the following item from my wfly1
% analysis to-do list: 1) are contralateral ORN synapses more distal than ipsi ORN synapses across PNs?


% Load annotations json. Generated by Wei's code gen_annotation_map.py
annotations=loadjson('~/tracing/sid_by_annotation.json');

% Return all skeleton IDs for R and L ORNs

ORNs_Left=annotations.Left_0x20_ORN;
ORNs_Right=annotations.Right_0x20_ORN;

%exclude unilateral ORNs for now

ORNs_Right(find(ORNs_Right == 499879))=[];
ORNs_Left(find(ORNs_Left == 426230))=[];
ORNs_Left(find(ORNs_Left == 401378))=[];

%exclude ORN 8 because it was temporarily unilateral on 8/5 for testing 
ORNs_Left(find(ORNs_Left == 593865))=[];



%return all skeleton IDs of DM6 PNs
PNs=annotations.PN;

% Loop over each PN and calculate the contact averaged path length for each
% ORN. I would like to compare ipsi and contra.

for c=1:length(PNs)
    
   
    
    %Load the PN skeleton into the workspace
    workingPN=loadjson(strcat('~/tracing/skeletons/', num2str(PNs(c)),'.json'));
    
    % generate an adjacency matrix indicating skeleton node connectivity
    
    [ edgeMatrix, verts ] = getSkelAdjMat_DW( workingPN );
    
    %Find its primary branch point
    
   
    for i=1:length(verts);
        if isempty(workingPN.vertices.(cell2mat(verts(i))).labels) == 1
            
        elseif strcmp(cell2mat(workingPN.vertices.(cell2mat(verts(i))).labels), 'primary branch point') == 1
           
            integrator=verts(i);
        else
            
        end
    end
   
        
    
    
    
    %Loop over ORNs and for each one calculate the contact averaged path
    %length to root
    
    for o=1:length(ORNs_Left);
        
        workingORN=ORNs_Left(o);
        inputSyns=getSynapseVerts(workingPN,workingORN);
        
        %Contact Averaged Path Lengths (CAPLs) calculated and stored
        [CAPL_Left(c,o), std, indLengths,paths]=meanPathToIntegrator(workingPN,edgeMatrix,verts,inputSyns,integrator);
        
    end
    
    for o=1:length(ORNs_Right);
        
        workingORN=ORNs_Right(o);
        inputSyns=getSynapseVerts(workingPN,workingORN);
        
        %Contact Averaged Path Lengths (CAPLs) calculated and stored
        [CAPL_Right(c,o), std, indLengths,paths]=meanPathToIntegrator(workingPN,edgeMatrix,verts,inputSyns,integrator);
        
    end
    
end
    

%% some plotting
% 
% [v ranks(:,1)]=sort(CAPL(1,:))
% [v ranks(:,2)]=sort(CAPL(2,:))
% [v ranks(:,3)]=sort(CAPL(3,:))
% [v ranks(:,4)]=sort(CAPL(4,:))
% [v ranks(:,5)]=sort(CAPL(5,:))


% Normalize CAPLs for each PN

for i=1:5
norm_CAPL_Left(i,:)=CAPL_Left(i,:)/max(CAPL_Left(i,:));
end


for i=1:5
norm_CAPL_Right(i,:)=CAPL_Right(i,:)/max(CAPL_Right(i,:));
end


% Scatter plot these normalized values against each other

titles={'PN3 LS', 'PN2 LS', 'PN1 RS', 'PN2 RS', 'PN1 LS'};

counter=1;
for i=1:5
    
    for j=1:5
        
        subplot(5,5,counter)
        
        scatter(norm_CAPL_Left(i,:),norm_CAPL_Left(j,:))
        hold on
        scatter(norm_CAPL_Right(i,:),norm_CAPL_Right(j,:), 'r')
        
        xlim([.6 1])
        ylim([.6 1])
        
        counter=counter+1;
        xlabel(titles(i))
        ylabel(titles(j))
        
    end
    
end



% looks like contact averaged path lengths are uncorrelated across PNs

for i=1:10000
    
    shuff_1=randperm(24);
    shuff_2=randperm(24);
    shuffCorr(i)=corr(shuff_1',shuff_2');
    
end

figure()
hist(shuffCorr, 100)

figure()
realCorr=corr(ranks)
hist(unique(realCorr(realCorr~=1)))

titles={'PN3 LS', 'PN2 LS', 'PN1 RS', 'PN2 RS', 'PN1 LS'};

for i=1:length(PNs)
    
    orns=[CAPL_Left(i,:),CAPL_Right(i,:)];
    grps=[zeros(1,length(CAPL_Left)), ones(1,length(CAPL_Right))];
    subplot(2,3,i)
    boxplot(orns,grps, 'notch', 'on', 'labels',{'Left ORNs','Right ORNs'})
    title(titles(i))
    set(gcf,'color','w');
    
end

% plot contact num vs CAPL for each PNs ORN inputs


titles={'PN3 LS', 'PN2 LS', 'PN1 RS', 'PN2 RS', 'PN1 LS'};

for i=1:length(PNs)
    

    subplot(2,3,i)

    
    scatter(left_contactNum(i,:),CAPL_Left(i,:),'k', 'filled')
    hold on
    scatter(right_contactNum(i,:),CAPL_Right(i,:),'r', 'filled')
        title(titles(i))
    set(gcf,'color','w');
    xlabel('Contact #')
    ylabel('CAPL')
end


% Boxplot CAPL of ipsi/contra ORN inputs to PNs



titles={'PN3 LS', 'PN2 LS', 'PN1 RS', 'PN2 RS', 'PN1 LS'};

for i=1:length(PNs)
    

    subplot(2,3,i)

    boxplot([CAPL_Left(i,:),CAPL_Right(i,:],[zeros(1,length(CAPL_Left

        title(titles(i))
    set(gcf,'color','w');
    xlabel('Contact #')
    ylabel('CAPL')
end



