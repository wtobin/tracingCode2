%The goal of this code is to calculate the path length of an axon
%collateral within an individual glomerulus. Additionally I would also like
%to find the number of presynaptic sites within the glomerulus

%% Load annotations and connectors

% Load annotations json. Generated by Wei's code gen_annotation_map.py
annotations=loadjson('~/tracing/sid_by_annotation.json');

% Return all skeleton IDs for R and L ORNs

ORNs_Left=annotations.Left_0x20_ORN;


%exclude unilateral ORNs for now

ORNs_Left(find(ORNs_Left == 426230))=[];
ORNs_Left(find(ORNs_Left == 401378))=[];



%for each ORN

for o=1:length(ORNs_Left)
tic
% Step #1 load ORN skeletons

workingSkel=loadjson(['~/tracing/skeletons/',num2str(ORNs_Left(o)),'.json']);


% STEP 2: generate the directed, weighted adjacency matrix and graph obj
%also return the list of skeleton vertex names that went into this
%adjacency matrix


[adjMat, skelVertNames]=getSkelAdjMat_DW_ORN(workingSkel);


%matrix is transposed to reflect my view of parent/child relationships,
%this is troublesome because I dont think it should be the
%case******!!!!!!!! TALK W? WEI ABOUT THIS

adjMat=adjMat';

%make a biograph object out of it
G=biograph(adjMat);


% This loop runs over the the verts that will go into the Adj Mat and looks for
% the start of the left axon/s

axonCounterL=1;
leftStart=[];

for v =1:length(skelVertNames)
    
    if isempty(cell2mat(workingSkel.vertices.(cell2mat(skelVertNames(v))).labels)) == 1
    else
        
% Return all skeleton IDs for R and L ORNs

ORNs_Left=annotations.Left_0x20_ORN;


%exclude unilateral ORNs for now

ORNs_Left(find(ORNs_Left == 426230))=[];
ORNs_Left(find(ORNs_Left == 401378))=[];


    if regexp(cell2mat(workingSkel.vertices.(cell2mat(skelVertNames(v))).labels),'caliber analysis') == 1
        
        leftStart(axonCounterL)=v;
        
        %leftStartNodeName=skelVertNames(v)
        axonCounterL=axonCounterL+1;
        
    else
    end
    end
end


for s = 1:length(leftStart)
% step 4 identify all nodes that are descendants of the left axon start 


%Traverse the graph from the left axon start vertex, as long as this node has
%all the glomerular collateral as descendants and no connection back to its
%parent this should yield the indicies of all nodes (from skelVertNames)
%involved in the collateral

leftAxonInds=G.traverse(leftStart(s));

for i=1:length(leftAxonInds)
    
   % Find the radius of each node
   
   axonRadii{o}(i)=workingSkel.vertices.(cell2mat(skelVertNames(leftAxonInds(i)))).radius;
   
end
   


end
toc
end

for o=1:25
    
    meanRadii(o)=mean(axonRadii{o});
    
    pathLength(o)=sum(leftAxons{o}(1,:));
    tbarNum(o)=sum(leftAxons{o}(2,:));
end
            
            for i=1:25
                toPn2LS(i)=getSynapseNum(ORNs_Left(i),PNs(1))
            end
            

%% Cable length V Fractional PN input

% Plotting
figure()
set(gcf, 'Color', 'w')

scatter(cLengths(1:25),  mean(contactNum_Fract(1:25,[1:3])'), 'filled')
hold on
scatter(cLengths(26:end),  mean(contactNum_Fract(26:end,[4:5])'), 'r', 'filled')
% xlim([0 .07])
% ylim([0 0.07])

xlabel('Ipsi Intra-glomerular Cable Length (nm)', 'FontSize', 16)
ylabel('Mean Fractional Input to Ipsi PNs', 'FontSize',16)
ax=gca;
ax.FontSize=16;

title('Cable Length V Fractional PN Input','FontSize', 18)
legend({'Left ORNs','Right ORNs'}, 'FontSize', 16, 'Location', 'NorthWest')

%Statistics

[pRho, pP]=corr(cLengths', [mean(contactNum_Fract(1:25,[1:3])'),mean(contactNum_Fract(26:end,[4:5])') ]')

text(1*10^5,.01,{['Pearson''s R val: ', num2str(pRho)]; ['Pearson''s P val: ', num2str(pP)]}, 'FontSize', 16)

%% tbar density (#tbar/nodes) V. total tbar number

% Plotting
figure()
set(gcf, 'Color', 'w')

scatter(psSites(1:25)./cLengths(1:25),  mean(contactNum_Fract(1:25,[1:3])'), 'filled')
hold on
scatter(psSites(26:end)./ cLengths(26:end),  mean(contactNum_Fract(26:end,[4:5])'), 'r', 'filled')
% xlim([0 .07])
% ylim([0 0.07])

xlabel('Tbar Density (tbars/nm)', 'FontSize', 16)
ylabel('Mean Fractional Input to Ipsi PNs', 'FontSize',16)
ax=gca;
ax.FontSize=16;

title('T bar Density V Fractional PN Input','FontSize', 18)
legend({'Left ORNs','Right ORNs'}, 'FontSize', 16, 'Location', 'NorthWest')

%Statistics
allTbarDens=[psSites(1:25)./cLengths(1:25),psSites(26:end)./ cLengths(26:end)]';
allContNumF=[[mean(contactNum_Fract(1:25,[1:3])'),mean(contactNum_Fract(26:end,[4:5])') ]'];

allTbarDens(40)=[];
allContNumF(40)=[];

[pRho, pP]=corr(allTbarDens, allContNumF,'type','Spearman' )

text(4*10^-4,.01,{['Spearman''s R val: ', num2str(pRho)]; ['Spearman''s P val: ', num2str(pP)]}, 'FontSize', 16)

%% tbar density (#tbar/nodes) V. intra-glomerular cable length

% Plotting
figure()
set(gcf, 'Color', 'w')

scatter(psSites(1:25)./cLengths(1:25),  cLengths(1:25), 'filled')
hold on
scatter(psSites(26:end)./ cLengths(26:end),  cLengths(26:end), 'r', 'filled')
% xlim([0 .07])
% ylim([0 0.07])

xlabel('Tbar Density (tbars/nm)', 'FontSize', 16)
ylabel('Ipsi Intra-glomerular cable length', 'FontSize',16)
ax=gca;
ax.FontSize=16;

title('T bar Density V Glomerular cable length','FontSize', 18)
legend({'Left ORNs','Right ORNs'}, 'FontSize', 16, 'Location', 'NorthWest')

%Statistics
allTbarDens=[psSites(1:25)./cLengths(1:25),psSites(26:end)./ cLengths(26:end)]';


allTbarDens(40)=[];
cLengths_mod=cLengths;
cLengths_mod(40)=[];

[pRho, pP]=corr(allTbarDens, cLengths_mod')

text(3.75*10^-4,.65*10^5,{['Pearson''s R val: ', num2str(pRho)]; ['Pearson''s P val: ', num2str(pP)]}, 'FontSize', 16)

%% intra-glomerular tbar num V Fractional ipsi PN input

% Plotting
figure()
set(gcf, 'Color', 'w')

scatter(psSites(1:25),  mean(contactNum_Fract(1:25,[1:3])'), 'filled')
hold on
scatter(psSites(26:end),  mean(contactNum_Fract(26:end,[4:5])'), 'r', 'filled')
% xlim([0 .07])
% ylim([0 0.07])

xlabel('Ipsi Intra-glomerular Cable Length (nm)', 'FontSize', 16)
ylabel('Mean Fractional Input to Ipsi PNs', 'FontSize',16)
ax=gca;
ax.FontSize=16;

title('Cable Length V Fractional PN Input','FontSize', 18)
legend({'Left ORNs','Right ORNs'}, 'FontSize', 16, 'Location', 'NorthWest')

%Statistics

[pRho, pP]=corr(cLengths', [mean(contactNum_Fract(1:25,[1:3])'),mean(contactNum_Fract(26:end,[4:5])') ]')

text(1*10^5,.01,{['Pearson''s R val: ', num2str(pRho)]; ['Pearson''s P val: ', num2str(pP)]}, 'FontSize', 16)

